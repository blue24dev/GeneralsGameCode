# Basics
This is a fork of [TheSuperHacker's 'GeneralsGameCode' repo](https://github.com/TheSuperHackers/GeneralsGamePatch/). TheSuperHacker's repo is an effort to fix many of the bugs remaining since the source code release of Command And Conquer Generals and its Zero Hour expansion. My fork is an extension of this.
The steps to set up this repo and build any executables/libraries are the same as there.

# Goals of this fork
- Fix additional bugs in the base game
	- Example: the phantom-dead-aircraft bug (more apparent on playing with 'AttackersMissPersistTime' for aurora bombers in the INI files)
	- Example: freeze/non-responsiveness due to an endless loop in map script indirection (poorly understood)
- Fix bug(s) seen in preprocessor constant choices to enable additional changes as of TheSuperHackers repo (GameDefines.h: setting 'RETAIL_COMPATIBLE_CRC' to 0)
	- Strategy center's building-specific abilities, such as CIA Intelligence and any battle plan changes, do not function (cooldown appears endless). Fixed by adding explicit initialization to a unit's local special powers when construction is finished, so that the cooldown in such a case doesn't remain at the default '0xffffffff' under the 'RETAIL_COMPATIBLE_CRC 0' change.
- Fix bugs more apparent in mods
	- Crashes more likely to happen in general in mods (object too close when firing a dumb projectile -> trying to use an arc with 0 points, poorly understood rare crash when sound cache peaks)
	- Crashes in debug mode (Talon/jumpjet troops using the jump ability in the Firestorm mod)
- Add additional features/compatability
	- Generals Challenge maps in Zero Hour - multiplayer compatibility
	- Real-time time-of-day change
	- Better logic for shroud jammers (mechanic not seen in retail generals - think the gap generator in the Red Alert series, or see stealth general radar vans with upgrade in ProGen)
	- Non-persistent shroud, so that shroud generated by a player disappears as a jammer moves/is destroyed instead of remaining behind
	- Advanced shroud mechanics, to make generating shroud a more useful tactic in multiplayer
		- Most units must move closer into player-induced shroud to reveal the area than their normal fog-of-war clearing range, particularly aircraft. The exception to this is stealth detectors, which reveal any shroud in their fog-clearing range regardless of the source.
		- Large-scale fog-clearing abilities, such as CIA Intelligence or Satellite Hack 2 (and likely similar abilities in mods), do not reveal player-induced shroud. You must get up close and personal to reveal what's behind deliberately jammed territory.
 - Optional/configurable: quick convenience features - adjust all units without having to edit many objects throughout the INI files (not all are active as of repo checkout)
	- All-around slower buildtimes to slow down the pace of the game
	- Increased health for all units to change the dynamics of the game
	- Increased sight (fog-of-war clearing) to reduce the AI opponent's advantage
	- An extra income multiplier for AI players to keep the game from stagnating
	- A forced starting-money amount for the often unforgiving Generals Challenge maps on hard difficulty

# Important Info
The changes made by this fork are not guaranteed to maintain any kind of CRC/save compatibility, even if some constants toward the top of GameDefines.h meant for controlling such are reverted. The goal of this fork is to fix as many bugs as possible, including enabling all TheSuperHackers compatibility-breaking fixes, and add additional features.
Anyone using builds from this fork for multiplayer should ensure all players are using identical builds, or builds compiled locally with the exact same state of the repo, including all constant config settings (mainly GameDefines.h).

Most changes made by this fork are for Zero Hour (the GeneralsMD folder) only for easier testing - updating the 'Generals' folder with these changes may be done at a later date so they transfer to the original 'CNC Generals' game.

Most changes have the 'MODDD' label to be easy to recognize. Changes surrounded by '#if''s involving constants created by this fork may lack the label since it's easy enough to imply this detail.

The 'LARGEADDRESSAWARE' linker flag has been added to the game executable to fix running out of memory & crashing when playing with significant extra assets (mods) combined with the 'REAL_TIME_TOD_CHANGE' constant set to 'TRUE' (precaches both day/night versions of models, usually only one variation is possible).
The flag boosts the maximum memory available to a 32-bit executable from 2 gigabytes to 4 gigabytes when run under 64-bit systems. For 32-bit systems, the maximum may be 3 gigabytes instead, or have other caveats - again, the goal of this fork is not preserving functionality on hardware at the time of the original game's release.
See 'GeneralsMD\Code\Main\CMakeLists.txt' for this change.

See descriptions for new setting constants in GameDefines.h.
Changes to these settings require a new build to take effect and are hardcoded into that particular build - these are not new INI settings that can be adjusted for an existing build.
Example: the 'GENERALS_CHALLENGE_FORCE' changes some context about how maps are handled - if set to 'TRUE' for a build, default behavior needed for skirmish games is skipped so GC maps can work as expected when run from the skirmish/lan/internet menu. If set to 'FALSE', retail behavior is used so typical skirmish-intended maps work as expected. You must use the build for its intended type of map - a setting='TRUE' build on skirmish maps will either crash or have no AI, while a setting='FALSE' build on GC maps will convert most opponent-intended units to civilian-control and may instantly end in victory/defeat.
- To avoid the need for this constant, a possible fix is to add some new flag to the map format that decides whether it is for skirmish or GC-play, and eventually the single player campaign (not interchangeable with GC). This flag can decide the expected behavior at startup instead of needing a particular build tailored per skirmish/GC map.

# Extra
- Search '2003 anymore' for some constants I changed for future-proofing. Putting them all in one place like GameDefines.h may make more sense.
- Search 'for me only' for things that are personal customizations in other places but I don't want to add many individual constants for - if they are accidentally left not-commented-out as of repo checkout, might want to disable them.
- See GameMemory.h. The new 'MEMORYPOOL_DEBUG_GARBAGE_FILL_ONLY' is a leaner alternative to the as-is 'MEMORYPOOL_DEBUG' to get a best-of-both-worlds compromise - more info there.
- Note that paradoxically, debug mode may make some crashes more likely to occur. Example: deleted memory is not supposed to be accessed anytime after it is deleted because he memory may be re-used for any other purposes as soon as it's deleted, though if usage occurs within a very short amount of time, it may not crash anyway in release mode since it hasn't had time to be repurposed. However, in debug mode, it may be immediately 0'd or overwritten with the '0xDEADBEEF' value to make misusages of deleted/garbage memory more apparent than usual. It is not good practice to treat a bug as 'fixed' simply because not immediately wiping memory like debug mode dodges the crash.
	- A bug observed in TheSuperHackers repo has been fixed in this fork related to this. Make a debug build with TheSuperHackers repo and try ordering a Talon jumpjet unit to jump in the FireStorm mod. The game crashes only in debug mode, not release mode nor the vanilla executable. This is because an OCL calls for deleting the current weapon while it is in the middle of performing other logic - this is fixed for debug mode by queueing the deletion for after the weapon logic is done.
	- See the "Exiting some games while in debug mode" issue below - there could be an issue similar to this in OpenContain/subclasses left to fix.

# Notable issues to be fixed
- Does the current forced-precache approach for real-time time-of-day change also precache normal/snow variations? That would be 4x the memory when only day/night variations (2x) is necessary.
- Fuel air bomb projectiles from aurora bombers in ProGen, most often the Airforce General's variant, are sometimes duds (no fuel air bomb detonation). Is this observed in the vanilla EXE / TheSuperHackers build too?
- Exiting some games while in debug mode can cause a crash in OpenContain or subclasses, possibly because something is being deleted twice or contained objects (garrisoned infantry, overlord turret?) are trying to do logic after having been deleted from a parent deleting is children (pending more detail).
	- Seems common on exiting the Rise of the Reds mod's splash map after letting it play for more than 30 seconds, such as quitting the program or starting a game (ex: skirmish) as usual - observed in TheSuperHackers build as well
	- Rarely occurs on exiting the game after loading some saved games, sometimes sometime consistently after playing them. This was on a Generals Challenge map several versions ago, so it is unsure if a source of the bug like this has been fixed completely by now.
